#!/bin/bash
echo $@

. /etc/environment

if [ "x$2" == "x" ]; then
	CONF=`basename $0 | cut -f1 -d'.'`
else
	CONF=$2
fi

if [ ! -f <%= kvmhost_etcpath %>/$CONF.conf ]; then
	echo "Error config file  <%= kvmhost_etcpath %>/$CONF.conf not found"
	exit 1
fi

. <%= kvmhost_etcpath %>/$CONF.conf

if [ "x$VNCID" == "x" ]; then
	VNCID=`grep INTIP <%= kvmhost_etcpath %>/$CONF.conf | cut -f4 -d'.'`
	if [ "x$VNCID" == "x" ]; then
		echo "no VNCID found"
		exit 1
	fi	
fi

if [ "x$EXTIP" == "x" ]; then
	EXTIP=`ifconfig <%= extif %> | grep "inet addr" | cut -f2 -d':' | cut -f1 -d' '`
elif [ `ifconfig | grep -c $EXTIP` -lt 1 ]; then
	if [ "x$INTIP" != "x" ]; then
		NETMASK=`facter | grep netmask_<%= extif %> | cut -f2 -d '>' | tr -d ' '` 
		ifconfig <%= extif %>:$VNCID $EXTIP	netmask $NETMASK up
	fi
fi

if [ -n "$1" ];then
	echo "starting network for $CONF on $1 Network: $INTIP <-> $EXTIP"
	/usr/sbin/tunctl -u root -t $1
	/sbin/ifconfig $1 0.0.0.0 up

	sleep 0.5s
	/sbin/brctl addif <%= bridgename %> $1
	if [ "x$INTIP" != "x" ]; then
		if [ `cat /proc/sys/net/ipv4/ip_forward` -lt 1 ]; then
			/sbin/sysctl -w net.ipv4.ip_forward=1
		fi

		/sbin/iptables -A FORWARD -s $INTIP/32 -j ACCEPT
		/sbin/iptables -t nat -I POSTROUTING -s $INTIP/32 -d <%= localnet %> -j ACCEPT
	
		let SSHPORT=2200+$VNCID
		/sbin/iptables -A FORWARD -d $INTIP/32 -p tcp --dport 22 -j ACCEPT
		/sbin/iptables -t nat -A PREROUTING -i <%= extif %> -p tcp --dport $SSHPORT -j DNAT --to-destination $INTIP:22
		
	
		if [ `iptables -t nat -L POSTROUTING | grep -c KVMPOSTROUTING` -lt 1 ]; then
			/sbin/iptables -t nat -N KVMPOSTROUTING 
			/sbin/iptables -t nat -A POSTROUTING -j KVMPOSTROUTING
		fi	
	        
		/sbin/iptables -t nat -A KVMPOSTROUTING -s $INTIP/32 -o <%= extif %> -j SNAT --to $EXTIP
		
	fi        
	echo $1 > <%= kvmhost_piddir %>/$CONF.tap

else
	echo "Error: no interface specified"
	exit 1
fi
